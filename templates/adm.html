<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../static/css/styleguide.css" />
    <link rel="stylesheet" href="../static/css/main.css" />
    <title>Office Shop</title>
  </head>
  <body>
    <div class="desktop">
      <div class="overlap">
        <!-- Barra lateral -->
        <div class="overlap-group">
          <div class="rectangle">
            <button id="homeBtn" class="iconSize buttonBox">
              <img class= "logo" src="../static/images/eos-icons--content-new.svg" />
            </button>
            <button id="settingsBtn" class="iconSize buttonBox">
              <img src="../static/images/eos-icons--content-new.svg" />
            </button>
            <button id="printerBtn" class="iconSize buttonBox">
              <img src="../static/images/eos-icons--content-new.svg" />
            </button>
            <button id="sendBtn" class="iconSize buttonBox">
              <img src="../static/images/eos-icons--content-new.svg" />
            </button>
            <button id="zapBtn" class="iconSize buttonBox">
              <img src="../static/images/eos-icons--content-new.svg" />
            </button>
          </div>
          <img class="logo" src="../static/images/v8_266.png" /> 
        </img>
        </div>
        <!--Fim Barra lateral -->

        <!--Nome da Corporação -->
        <p>
          <span class="text-wrapper">A Estudante<br /></span>
          <span class="span">Office shop</span>
        </p>
        <!--Fim Nome da Corporação -->
        
        <!--Icones Add e Filtro-->
        <button id="addRowBtn" class="addRow buttonBox">
          <img src="../static/images/eos-icons--content-new.svg" />
        </button>
        <button id="filterBtn" class="filter buttonBox">
          <img src="../static/images/eos-icons--content-lifecycle-management.svg" />
        </button>

        <!--Definição de linha na tabela -->
        <div id="tableContainer">
          {% for produto in produtos %}
          <div class="tableRow">
            <form class="updateForm" data-id="{{ produto.id_produtos }}">
              <input
                class="divWrapper defaultBox"
                style="width: 20%"
                name="nome_produtos"
                value="{{ produto.nome_produtos }}"
                placeholder="Nome"
              />
              <input
                class="divWrapper defaultBox"
                style="width: 56.4%"
                name="descricao_produtos"
                value="{{ produto.descricao_produtos }}"
                placeholder="Descrição"
              />
              <input
                class="divWrapper defaultBox"
                style="width: 1%"
                name="quantidade_produtos"
                value="{{ produto.quantidade_produtos }}"
                placeholder="Qtd"
              />
              <button
                type="button"
                class="trashBtn iconSize buttonBox"
                style="width: 48px; top: 18px;"
              >
                <img src="../static/images/eos-icons--content-deleted.svg" />
              </button>
            </form>
          </div>
          {% endfor %}
        </div>
        <!--Fim Definição de Linha -->
      </div>
    </div>

    <script>
      //Função que configura listeners para update e delete
      function setupListeners(form) {
        const id = form.getAttribute("data-id");
        console.log(id);
        const debounceTime = 3000; // Time in milliseconds
        let debounceTimer;

        form.querySelectorAll("input").forEach((input) => {
          input.addEventListener("input", function () {
            // Clear the previous timer
            clearTimeout(debounceTimer);

            // Set a new timer
            debounceTimer = setTimeout(() => {
              const formData = new FormData(form);
              fetch(`/${id}/update`, {
                method: "POST",
                body: formData,
              }).then((response) => {
                if (response.ok) {
                  console.log("Product updated successfully");
                } else {
                  console.error("Error updating product");
                }
              });
            }, debounceTime);
          });
        });

        form.querySelectorAll(".trashBtn").forEach((button) => {
          button.addEventListener("click", function () {
            fetch(`/${id}/delete`, { method: "POST" }).then((response) => {
              if (response.ok) {
                this.closest(".tableRow").remove();
              } else {
                console.error("Error deleting product");
              }
            });
          });
        });
      }

      //inserção de listeners nas linhas obtidas do banco de dados durante o startup da web aplicação
      document.querySelectorAll(".updateForm").forEach((form) => {
        setupListeners(form);
      });

      //logica da criação de novas linhas na tabela
      document
        .getElementById("addRowBtn")
        .addEventListener("click", function () {
          //definição do HTML
          const newRow = document.createElement("div");
          newRow.classList.add("tableRow");
          newRow.innerHTML = `
      <form class="updateForm" data-id="null">
          <input class="divWrapper defaultBox" style="width: 20%;" name="nome_produtos" placeholder="Nome" />
          <input class="divWrapper defaultBox" style="width: 56.4%;" name="descricao_produtos" placeholder="Descrição" />
          <input class="divWrapper defaultBox" style="width: 1%;" name="quantidade_produtos" placeholder="Qtd" />
          <button type="button" class="trashBtn iconSize buttonBox" style="width: 48px;">
              <img src="../static/images/mi--delete(1).svg" />
          </button>
      </form>
    `;

          //definição da lista objeto representando os elementos de uma linha
          const formElement = newRow.querySelector(".updateForm");
          const formData = new FormData(formElement);

          //invoca o metodo criar linha e recebe de volta o id da linha no banco de dados
          fetch("/add", {
            method: "POST",
            body: formData,
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error("Network response was not ok");
              }
              return response.json();
            })
            .then((data) => {
              //atualiza o elemento html com o id recebido e configura os listeners para que essa linha possa ser editavel
              formElement.setAttribute("data-id", data.id);
              setupListeners(formElement);
              console.log(
                "New product added successfully, ID:",
                formElement.getAttribute("data-id")
              );
              document.getElementById("tableContainer").appendChild(newRow);
            })
            .catch((error) => {
              console.error("Error adding new product:", error);
            });
        });

      document
        .getElementById("filterBtn")
        .addEventListener("click", function () {
          // Collect filter criteria from the input fields (you can customize this)
          const filterData = new FormData();
          const nameInput = document.querySelector(
            "input[name='nome_produtos']"
          ).value;
          const descriptionInput = document.querySelector(
            "input[name='descricao_produtos']"
          ).value;
          const quantityInput = document.querySelector(
            "input[name='quantidade_produtos']"
          ).value;

          // Append filter criteria to FormData
          filterData.append("nome_produtos", nameInput);
          filterData.append("descricao_produtos", descriptionInput);
          filterData.append("quantidade_produtos", quantityInput);

          // Send the filter request to the server
          fetch("/filter", {
            method: "POST",
            body: filterData,
          })
            .then((response) => response.json())
            .then((data) => {
              // Clear existing rows
              const tableContainer = document.getElementById("tableContainer");
              tableContainer.innerHTML = "";

              // Add filtered products back to the table
              data.produtos.forEach((produto) => {
                const newRow = document.createElement("div");
                newRow.classList.add("tableRow");
                newRow.innerHTML = `
        <form class="updateForm" data-id="${produto.id_produtos}">
          <input class="divWrapper defaultBox" style="width: 20%;" name="nome_produtos" value="${produto.nome_produtos}" placeholder="Nome" />
          <input class="divWrapper defaultBox" style="width: 56.4%;" name="descricao_produtos" value="${produto.descricao_produtos}" placeholder="Descrição" />
          <input class="divWrapper defaultBox" style="width: 1%;" name="quantidade_produtos" value="${produto.quantidade_produtos}" placeholder="Qtd" />
          <button type="button" class="trashBtn iconSize defaultBox" style="width: 48px;" data-id="${produto.id_produtos}">
            <img src="../static/images/mi--delete(1).svg" />
          </button>
        </form>
      `;
                tableContainer.appendChild(newRow);
                setupListeners(newRow.querySelector(".updateForm")); // Setup listeners for new rows
              });
            })
            .catch((error) => {
              console.error("Error filtering products:", error);
            });
        });

        document
          .getElementById("homeBtn")
        .addEventListener("click", function () {
          fetch("/", {
            method: "GET"
          }).then((response) => response.json())
            });

    </script>
  </body>
</html>
